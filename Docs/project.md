# Электронный таймер для авиамодели F1C

## 1. Общая концепция

Проект представляет собой систему, состоящую из бортового модуля на базе ESP8266 и мобильного приложения на Flutter. Система предназначена для замены традиционных механических таймеров на авиамоделях, предоставляя гибкую настройку полетных программ и возможность сбора и анализа полетных данных.

Основной принцип работы: планер полностью автономен в полете. Мобильное приложение используется исключительно на земле для предварительной настройки бортового модуля и для скачивания телеметрии после завершения полета.

## 2. Ключевые компоненты

*   **Бортовой модуль:** Устройство на базе ESP8266, управляющее сервоприводом для смены режимов полета и считывающее данные с барометрического датчика. Управление запуском осуществляется одной физической кнопкой.
*   **Мобильное приложение (Flutter):** Кроссплатформенное приложение для iOS и Android, выполняющее роль центра управления профилями планеров, редактора полетных программ и инструмента для анализа сохраненных полетов.

## 3. Жизненный цикл системы

### Фаза 1: Настройка на земле

1.  Пользователь в приложении создает/выбирает профиль планера и полетную программу.
2.  Пользователь включает бортовой модуль. Модуль пытается подключиться к известной Wi-Fi сети (режим клиента) или, если это не удается, создает свою точку доступа (режим AP).
3.  Приложение подключается к модулю для загрузки полетной программы и скачивания старых логов.

### Фаза 2: Предстартовая подготовка и полет

1.  **"Взведение" системы:** Пилот активирует систему первым коротким нажатием кнопки на планере. Модуль переходит в **режим ожидания старта ("Armed")**. Светодиод на модуле сигнализирует о готовности.
2.  **Отмена старта:** Если пилот передумал взлетать (например, изменились погодные условия), он может выйти из режима ожидания, **удерживая кнопку в течение 3 секунд**. Модуль вернется в исходный режим настройки, снова активировав Wi-Fi.
3.  **Запуск полета:** Вторым коротким нажатием кнопки пилот запускает полет. Модуль переходит в **режим полета ("Flight")**, немедленно **отключает Wi-Fi** для экономии энергии, активирует таймер (t=0) и начинает выполнять загруженную программу.
4.  **Автономный полет:** В заданные моменты времени сервопривод срабатывает, меняя режимы полета. Параллельно модуль с частотой 1 раз в секунду записывает показания высоты в свою внутреннюю память.

### Фаза 3: Анализ после полета

1.  После посадки и выключения/включения питания модуль снова переходит в режим настройки.
2.  Пользователь подключает приложение к модулю и скачивает новые данные о полетах.
3.  Данные анализируются в приложении (статистика, графики).

## 4. Технические спецификации

### Прошивка (ESP8266)

*   **Режимы работы:**
    *   **Настройка (AP/STA):** Wi-Fi включен, ожидание команд по HTTP.
    *   **Ожидание старта (Armed):** Активирован кнопкой, ждет старта. Wi-Fi все еще включен. Выход из режима — длительное нажатие (3 сек), возвращающее в режим Настройки.
    *   **Полет (Flight):** Активирован второй кнопкой. **Wi-Fi модуль отключен.** Выполняется программа и запись лога. Выход из режима — только по завершении программы или отключении питания.
*   **Индикация (LED):**
    *   Редкое мигание: Режим точки доступа.
    *   Постоянное свечение: Подключен к Wi-Fi / Идет полет.
    *   Плавное мигание ("дыхание"): Режим ожидания старта.
*   **Файловая система (LittleFS):** `wifi.json`, `program.json`, `log_N.dat`.

### Мобильное приложение (Flutter)

*   **Архитектура:** Приложение построено на принципах Clean Architecture с использованием Riverpod для управления состоянием. Обеспечивает реактивное обновление интерфейса на основе данных с устройства.
*   **Управление профилями:** Главный экран позволяет создавать, редактировать и удалять профили для разных моделей планеров, сохраняя настройки и историю для каждого отдельно.
*   **Приборная панель (Dashboard):** Основной экран взаимодействия с бортом:
    *   **Телеметрия:** Отображение высоты, температуры и давления в реальном времени (механизм Polling).
    *   **Управление подключением:** Автоматический поиск устройства, индикация статуса Wi-Fi и ошибок оборудования (Hardware Error).
    *   **Калибровка:** Интерактивный интерфейс для быстрого обнуления высоты (Zero) и полной калибровки датчиков с визуализацией прогресса и возможностью отмены операций.
    *   **Настройки датчиков:** Управление питанием/опросом барометра для экономии энергии.
*   **Полетные программы:**
    *   Визуальный редактор шагов работы сервопривода (направление, длительность).
    *   Загрузка программ в память контроллера через Wi-Fi с подтверждением доставки.
*   **История полетов:** Инструментарий для скачивания «сырых» логов давления из памяти устройства и их последующей обработки (расчет высоты, построение графиков) на стороне смартфона.

### Форматы данных и API

*   Форматы `program.json`, `log_N.dat` и протокол RESTful API остаются без изменений. API недоступен в режиме полета.

#### Стратегия обработки данных (Гибридный подход)

Для обеспечения максимальной точности анализа и быстродействия интерфейса принята следующая схема разделения ответственности:

1.  **Режим реального времени (Telemetry / Live):**
    *   **На плате:** Высота рассчитывается микроконтроллером.
    *   **Передача:** В API `/status` передается готовое значение высоты (в метрах).
    *   **Цель:** Минимизация трафика и задержек отображения в UI перед стартом.

2.  **Режим истории полета (History / Black Box):**
    *   **На плате:** В файл лога записываются только **сырые данные давления (Pa)** и временные метки. Высота в файл не пишется.
    *   **В приложении:** После скачивания лога приложение самостоятельно рассчитывает высоту на основе сырого давления.
    *   **Цель:**
        *   Возможность **Post-flight Re-zeroing** (корректировки точки нуля после полета, если давление изменилось).
        *   Гибкая настройка фильтрации (сглаживания) графиков на стороне смартфона.
        *   Возможность применения улучшенных формул расчета высоты без обновления прошивки устройства.

## 5. Механизмы надежности и удобства

*   **Тайм-аут подключения:** Модуль не "зависает" при поиске несуществующей сети Wi-Fi, а переключается в режим точки доступа.
*   **Отмена старта:** Пользователь может безопасно отменить взлет из "взведенного" состояния длительным нажатием кнопки, не отключая питание.
*   **Идентификация логов:** Каждый лог получает уникальный ID (timestamp), что предотвращает дублирование данных.
*   **Четкая обратная связь:** Приложение информирует пользователя о статусе всех операций.
*   **Аварийный сброс Wi-Fi:** Длительное (5-10 сек) удержание кнопки при включении сбрасывает настройки Wi-Fi.